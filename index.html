<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Pixel Wars</title>

        <style>
            .container {
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap : 4px;
            }
            .map{
                display: grid;
                grid-template-rows: repeat(3, 10px);
                grid-template-columns: repeat(3, 10px);
            }
            .pixel {
                width: 10px;
                height: 10px;
                border: 1px solid black;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <input type="text" name="adresse" id="adresse" value="https://pixels-war.oie-lab.net">
                <input type="text" name="map" id="map", value="TEST">
            </div>
            <div class="map" id="mapcontainer">
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
            </div>
            <div class="footer">
                <input type="color" name="couleur" id="couleur" value="#0000FF">
            </div>
        </div>


        <script>
            const adresse = document.querySelector("#adresse").value;
            const carte = document.querySelector("#map").value;
            const couleur = document.querySelector("#couleur").value;
            console.log({adresse, carte, couleur})
            
            const mapElement = document.querySelector("#mapcontainer")

            async function preinit() {
                const res = await fetch(`${adresse}/api/v1/${carte}/preinit`, {credentials: "include"});
                const { key } = await res.json();
                init(key)
            }
            

            async function init(key) {
                const res = await fetch(`${adresse}/api/v1/${carte}/init?key=${key}`, {credentials: "include"});
                const { id, nx, ny, timeout, data } = await res.json()
                
                let contenu = "";
                for (let col = 0; col < nx; col++) {
                    for (let li = 0; li < ny; li++){
                        const [r, g, b] = data[li][col];
                        contenu += `<div class="pixel" id="l${li}_c${col}" style="background-color: rgb(${r}, ${g}, ${b})"></div>`;
                    }
                }

                mapElement.innerHTML = contenu;
                mapElement.style.gridTemplateColumns = `repeat(${nx}, 10px)`
                mapElement.style.gridTemplateRows = `repeat(${ny}, 10px)`
              

                console.log(contenu);

                setInterval(() => deltas(id), 1000);
            }

            async function deltas(id) {
                const res = await fetch(`${adresse}/api/v1/${carte}/deltas?id=${id}`, {credentials: "include"})
                const { deltas } = await res.json();
                for ([x, y, r, g, b] of deltas) {
                    console.log("delta", [x, y, r, g, b]);
                    const pixel = document.querySelector(`#l${y}_c${x}`);
                    pixel.style.backgroundColor = `rgb(${r},${g},${b})`;
                    }
                }
            
                

            preinit()

        </script>
    </body>
</html>